# Sliding Window vs Sliding Log 区别详解

## 核心区别

### Sliding Window（滑动窗口）
- **实现方式**：将时间窗口**分成多个子窗口（buckets）**
- **存储**：每个子窗口只存储**计数**，不存储具体时间戳
- **内存占用**：**低**（只存储固定数量的计数）
- **精度**：**中等**（取决于子窗口数量）

### Sliding Log（滑动日志）
- **实现方式**：记录**每个请求的精确时间戳**
- **存储**：存储所有请求的时间戳
- **内存占用**：**高**（存储所有时间戳）
- **精度**：**最高**（精确到毫秒）

## 详细对比

| 特性 | Sliding Window | Sliding Log |
|------|---------------|-------------|
| **存储方式** | 子窗口计数 | 每个请求的时间戳 |
| **内存占用** | 低（固定数量） | 高（随请求数增长） |
| **时间复杂度** | O(1) | O(n) |
| **精度** | 中等（取决于分桶数） | 最高（精确到毫秒） |
| **清理操作** | 简单（更新计数） | 复杂（删除过期时间戳） |
| **适用场景** | 高并发场景 | 精确限流场景 |

## 实现原理对比

### Sliding Window（分桶实现）

```
时间窗口：10秒，分成10个子窗口，每个子窗口1秒

时间轴：  [0s] [1s] [2s] [3s] [4s] [5s] [6s] [7s] [8s] [9s]
计数：     [2]  [3]  [1]  [4]  [2]  [3]  [1]  [2]  [1]  [3]
          ↑                                    ↑
        窗口开始                              当前时间

当前窗口计数 = 最近10个子窗口的计数之和
```

**优点**：
- 内存占用固定（只存储子窗口数量）
- 更新操作O(1)
- 适合高并发场景

**缺点**：
- 精度取决于子窗口数量
- 子窗口边界可能有误差

### Sliding Log（精确时间戳）

```
时间窗口：10秒

时间戳队列：
[1000ms, 1200ms, 1500ms, 2000ms, 2500ms, 3000ms, ...]

当前时间：10000ms
窗口开始：0ms
统计：计算 [0ms, 10000ms) 内的所有时间戳数量
```

**优点**：
- 精度最高（精确到毫秒）
- 可以精确统计任意时间窗口

**缺点**：
- 内存占用随请求数增长
- 清理操作需要遍历
- 高并发时性能较差

## 实际代码对比

### 当前实现的问题

**注意**：当前代码库中的 `SlidingWindowRateLimiter` 和 `SlidingLogRateLimiter` 
实际上都使用了相同的实现方式（存储所有时间戳），这**不是真正的滑动窗口**。

真正的区别应该是：

1. **Sliding Window**：使用分桶（buckets）存储计数
2. **Sliding Log**：存储所有时间戳

## 性能对比示例

假设：限制每秒100个请求，时间窗口10秒

### Sliding Window（分桶）
- 子窗口数：10个（每个1秒）
- 内存占用：10个long（约80字节）
- 更新操作：O(1)
- 统计操作：O(1)（累加10个计数）

### Sliding Log（时间戳）
- 时间戳数：最多1000个（10秒 × 100/秒）
- 内存占用：1000个long（约8000字节）
- 更新操作：O(1)（添加时间戳）
- 统计操作：O(n)（需要遍历清理过期时间戳）

## 适用场景

### Sliding Window 适合：
- ✅ **高并发场景**（内存占用固定）
- ✅ **对精度要求不高的场景**（子窗口足够多时精度可接受）
- ✅ **需要高性能的场景**（O(1)操作）
- ✅ **长时间运行的场景**（内存不会无限增长）

### Sliding Log 适合：
- ✅ **需要精确限流的场景**（精确到毫秒）
- ✅ **请求量不大的场景**（内存占用可控）
- ✅ **需要精确统计的场景**（可以统计任意时间窗口）
- ✅ **对内存不敏感的场景**

## 选择建议

```
需要什么精度？
│
├─ 高精度（精确到毫秒）→ Sliding Log
│   • 请求量不大
│   • 需要精确统计
│
└─ 中等精度（子窗口级别）→ Sliding Window
    • 高并发场景
    • 需要高性能
    • 内存受限
```

## 总结

| 场景 | 推荐算法 | 原因 |
|------|---------|------|
| **高并发API限流** | Sliding Window | 内存占用固定，性能好 |
| **精确限流（低并发）** | Sliding Log | 精度最高 |
| **长时间运行服务** | Sliding Window | 内存不会无限增长 |
| **需要精确统计** | Sliding Log | 可以统计任意时间窗口 |

## 记忆口诀

- **Sliding Window**：分桶计数，内存固定，性能好
- **Sliding Log**：精确时间戳，内存增长，精度高
